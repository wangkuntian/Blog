---
title: IPsec协议
published: 2025-12-12
description: ""
image: ""
tags: ["网络", "网络基础"]
category: "网络"
draft: false
lang: ""
---

# 什么是 IPsec？

​**​IPsec​**​（Internet Protocol Security）是一套 ​**​ 协议套件 ​**​，而不是单个协议。它为在 IP 网络上传输的数据提供 ​**​ 加密、认证和完整性校验 ​**​ 等安全服务，确保数据在公共网络（如互联网）上传输时的机密性和安全性。

它的核心目标是保护 IP 层（网络层）的通信，因此它能够为上层（如 TCP、UDP）的所有应用和服务（如网页浏览、电子邮件、文件传输等）提供透明的安全保护，而无需应用程序本身做任何修改。

# IPsec 的原理是什么？

IPsec 的工作原理可以分解为几个核心组成部分和步骤：

## 1. 核心安全协议

IPsec 主要使用两个协议来提供安全服务：

-   ​**​AH (Authentication Header，认证头)​**​
    -   ​**​ 功能 ​**​：提供 ​**​ 数据源认证 ​**​ 和 ​**​ 数据完整性校验 ​**​（防篡改），确保数据包来自可信的源且在传输过程中未被修改。
    -   ​**​ 特点 ​**​：​**​ 不提供加密 ​**​，因此不会对数据负载进行保密处理。由于它也会对 IP 头的一部分进行认证，在与 NAT（网络地址转换）设备一起使用时会产生冲突，因此现在应用较少。
-   ​**​ESP (Encapsulating Security Payload，封装安全载荷)​**​
    -   ​**​ 功能 ​**​：提供 ​**​ 加密 ​**​（保密性）、​**​ 数据源认证 ​**​ 和 ​**​ 数据完整性校验 ​**​。它是目前最常用的 IPsec 协议。
    -   ​**​ 特点 ​**​：只认证它自己封装的载荷部分，不认证外部的 IP 头，因此可以顺利通过 NAT 设备。

## 2. 工作模式

上述协议（AH 和 ESP）有两种工作模式：

-   ​**​ 传输模式 (Transport Mode)​**​
    -   ​**​ 原理 ​**​：只对 IP 数据包的 ​**​ 载荷（Payload）​**​（即上层协议数据，如 TCP、UDP 段）进行保护，IP 头部保持不变。
    -   ​**​ 应用场景 ​**​：主要用于 ​**​ 端到端 ​**​（End-to-End）的保护，例如两台主机之间的直接通信。
-   ​**​ 隧道模式 (Tunnel Mode)​**​
    -   ​**​ 原理 ​**​：保护 ​**​ 整个原始的 IP 数据包 ​**​。它会将原始 IP 包（包括 IP 头和载荷）整个加密和认证，然后将其作为载荷，再加上一个新的 IP 头，形成一个新的 IP 数据包。
    -   ​**​ 应用场景 ​**​：主要用于 ​**​ 站点到站点 ​**​（Site-to-Site）的 VPN，例如连接两个不同地区的公司局域网。网关设备（如路由器、防火墙）通常使用此模式。

| 模式               | 保护的内容          | 典型应用                       |
| ------------------ | ------------------- | ------------------------------ |
| ​**​ 传输模式 ​**​ | IP 载荷（原始数据） | 主机到主机的安全通信           |
| ​**​ 隧道模式 ​**​ | 整个原始 IP 包      | 网络到网络的 VPN（站点到站点） |

## 3. 密钥管理与交换

为了建立安全通信，通信双方必须就加密/认证算法、密钥等参数达成一致。这是通过 ​**​IKE（Internet Key Exchange，互联网密钥交换）​**​ 协议完成的。

IKE 协议分为两个阶段：

-   ​**​IKE 阶段 1​**​：建立一条 ​**​ 安全、认证的通道 ​**​（称为 IKE SA）。双方在此通道上协商如何保护后续的通信。通常使用 ​**​ 主模式 ​**​ 或 ​**​ 积极模式 ​**​。
-   ​**​IKE 阶段 2​**​：在阶段 1 建立的安全通道内，协商用于保护实际用户数据的 IPsec 安全参数（称为 IPsec SA）。通常使用 ​**​ 快速模式 ​**​。

SA（Security Association，安全关联）是 IPsec 的核心概念，它是通信双方之间为保护数据流而建立的一个“合同”，规定了使用的协议（AH/ESP）、模式、加密算法、密钥、生命周期等所有参数。

## 4. 工作原理总结（简化步骤）

1. ​**​ 触发 ​**​：当一台主机需要向另一台主机发送数据时，如果数据流匹配预先配置的“感兴趣流”（例如，目的地是另一个私有网络），IPsec 进程就会被触发。
2. ​**​IKE 阶段 1​**​：双方协商建立 IKE SA，相互认证身份（使用预共享密钥或数字证书）。
3. ​**​IKE 阶段 2​**​：在 IKE SA 的保护下，协商建立 IPsec SA，确定加密算法（如 AES）、认证算法（如 SHA）、密钥等。
4. ​**​ 数据传输 ​**​：使用 IPsec SA 的参数，对数据包进行加密和认证（ESP 通常），然后通过隧道模式或传输模式发送。
5. ​**​ 接收处理 ​**​：接收方收到数据包后，根据 IPsec SA 查找对应的密钥和算法，对数据包进行解密和验证。验证通过后，将原始数据包传递给上层协议。

# 有哪些应用场景？

IPsec 最常见的应用是构建 ​**​VPN（虚拟专用网络）​**​，它在不安全的公共网络上创建一个安全的私有隧道。

1. ​**​ 站点到站点 VPN (Site-to-Site VPN)​**​
    - ​**​ 描述 ​**​：连接两个地理上分散的局域网（例如总部和分支办公室），让它们像一个统一的私有网络一样工作。
    - ​**​ 实现 ​**​：通常在两个网络的网关（如路由器、防火墙）之间建立 IPsec 隧道（隧道模式）。所有在两个网络之间传输的流量都会自动通过这个加密隧道。
2. ​**​ 远程访问 VPN (Remote Access VPN)​**​
    - ​**​ 描述 ​**​：让远程用户（如出差员工、在家办公者）安全地访问公司内部网络资源。
    - ​**​ 实现 ​**​：用户在个人电脑上运行 VPN 客户端软件，与公司的 VPN 网关建立 IPsec 连接。连接成功后，用户的设备就像直接连接在公司内网一样。
3. ​**​ 端到端安全通信 (End-to-End Security)​**​
    - ​**​ 描述 ​**​：为两台主机之间的直接通信提供保护，例如两台服务器之间传输敏感数据。
    - ​**​ 实现 ​**​：在主机本身配置 IPsec 策略（传输模式），由主机直接处理数据的加密和解密。
4. ​**​IPv6 安全 ​**​
    - ​**​ 描述 ​**​：IPsec 最初是为 IPv6 设计的，是其原生组成部分。虽然 IPv4 也可使用 IPsec，但在 IPv6 中，支持 IPsec 是强制性的，为下一代互联网提供了内置的安全基础。

# 总结

| 方面               | 描述                                                                                         |
| ------------------ | -------------------------------------------------------------------------------------------- |
| ​**​ 是什么 ​**​   | 一套保护 IP 层通信安全的协议套件，提供加密、认证和完整性。                                   |
| ​**​ 核心协议 ​**​ | ​**​AH​**​（认证，不加密），​**​ESP​**​（认证和加密，最常用）。                              |
| ​**​ 工作模式 ​**​ | ​**​ 传输模式 ​**​（保护载荷，用于主机间通信），​**​ 隧道模式 ​**​（保护整个包，用于 VPN）。 |
| ​**​ 密钥管理 ​**​ | ​**​IKE 协议 ​**​ 负责自动协商密钥和安全参数，建立安全关联（SA）。                           |
| ​**​ 主要应用 ​**​ | ​**​ 站点到站点 VPN​**​、​**​ 远程访问 VPN​**​，是构建企业级安全网络的核心技术。             |

简单来说，IPsec 就像是一个专业的 ​**​ armored car（装甲运钞车）服务 ​**​。你的数据（ money）被放进车里（加密），车辆有防弹功能（完整性保护），并且有专人验证司机的身份（认证），然后通过公共道路（互联网）安全地运送到目的地。无论是整条路都被保护起来（站点到站点），还是只为单个包裹提供服务（远程访问），IPsec 都能胜任。
