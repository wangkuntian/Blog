---
title: Geneve协议
published: 2025-12-12
description: ""
image: ""
tags: ["网络", "虚拟网络"]
category: "网络"
draft: false
lang: ""
---

Geneve（Generic Network Virtualization Encapsulation，通用网络虚拟化封装）是一种 ​**​ 先进的 Overlay 网络封装协议 ​**​，旨在解决早期 Overlay 技术（如 VXLAN、NVGRE）的局限性，并提供更强大、灵活和面向未来的网络虚拟化框架。它由 IETF 标准化（RFC 8926）。

# 核心目标与设计理念 ​

1. ​**​ 统一与通用性：​**​ Geneve 试图成为“一种协议统治所有”（One Protocol to Rule Them All），取代 VXLAN、NVGRE、STT 等多种互不兼容的封装格式，简化网络架构和互操作性。
2. ​**​ 可扩展性：​**​ 这是 Geneve 最核心的创新。它定义了一个 ​**​ 灵活且可扩展的封装头部 ​**​，允许携带任意数量和类型的元数据（Metadata），而无需修改协议本身。这为 SDN 控制器、网络功能和服务提供了丰富的上下文信息传递通道。
3. ​**​ 面向 SDN/NFV：​**​ 设计之初就充分考虑了软件定义网络（SDN）和网络功能虚拟化（NFV）的需求，强调与控制平面的紧密集成。
4. ​**​ 保持性能：​**​ 在提供强大功能的同时，尽量优化封装格式，减少开销，并考虑硬件卸载的可能性。

# ​Geneve 报文封装结构详解 ​

一个 Geneve 数据包由以下几部分组成（从内到外）：

## 1. ​​ 原始数据包 (Inner Packet)​​

这是需要穿越底层网络传输的原始数据帧，可以是：

-   ​**​ 以太网帧 (L2)：​**​ 用于构建虚拟二层网络（VXLAN 的主要场景）。
-   ​**​IP 数据包 (L3)：​**​ 用于构建虚拟三层网络或 IP VPN。
-   理论上可以是任何协议的数据包。

## 2. ​Geneve 头部 (Geneve Header)

这是协议的核心部分，包含以下字段：

-   ​**​Version (2 bits)：​**​ 当前版本为 `0`。
-   ​**​Options Length (6 bits)：​**​ 指示 ​**​ 可变长选项 (Variable-Length Options)​**​ 部分的长度（以 4 字节为单位）。例如，`0` 表示没有选项，`1` 表示 4 字节选项，`2` 表示 8 字节，以此类推（最大 124 字节）。
-   ​**​O (1 bit)：​**​ Control Packet 标志位。通常为 `0` 表示数据包。`1` 可能用于控制或 OAM 报文（具体用途待定义）。
-   ​**​C (1 bit)：​**​ Critical Options Present 标志位。如果置 `1`，表示 Geneve 头部中包含至少一个被接收端标记为“关键”的选项。如果接收端不理解关键选项，必须丢弃该包。
-   ​**​Reserved (6 bits)：​**​ 保留位，必须置 `0`。
-   ​**​Protocol Type (16 bits)：​**​ 指示 ​**​ 原始数据包（Inner Packet）的类型 ​**​（以太类型 EtherType）。例如：
    -   `0x0800` = IPv4
        -   `0x86DD` = IPv6
        -   `0x0806` = ARP
        -   `0x6558` = Transparent Ethernet Bridging (TEB) - 原始以太网帧
-   ​**​Virtual Network Identifier (VNI) (24 bits)：​**​ 标识数据包所属的 ​**​ 虚拟网络或租户 ​**​。功能类似于 VXLAN 的 VNI 或 VLAN ID，但范围更大（16M+）。这是 ​**​ 唯一固定存在的标识符 ​**​。
-   ​**​Reserved (8 bits)：​**​ 保留位，必须置 `0`。
-   ​**​ 可变长选项 (Variable-Length Options)：​**​ 这是 Geneve 的 ​**​ 灵魂所在 ​**​。它是一个由零个或多个 ​**​TLV (Type-Length-Value)​**​ 结构组成的列表。
    -   ​**​Class (16 bits)：​**​ 定义选项的 ​**​ 命名空间或类别 ​**​。IANA 管理注册。例如，`0x0100` - `0x01FF` 可能预留给 IETF 标准选项，`0xExxx` 预留给实验/私有用途。这有助于避免不同组织定义的选项类型冲突。
        -   ​**​Type (8 bits)：​**​ 在特定 `Class` 下定义具体的 ​**​ 选项类型 ​**​。
        -   ​**​R (3 bits)：​**​ Reserved，保留位。
        -   ​**​Length (5 bits)：​**​ 指示 ​**​Value​**​ 字段的长度（以 4 字节为单位）。`0` 表示只有 4 字节的 TLV 头，没有 Value。
        -   ​**​Value (可变长)：​**​ 选项携带的实际 ​**​ 元数据内容 ​**​。长度必须是 4 字节的倍数（由 `Length` 字段指定）。内容格式由 `Class` 和 `Type` 定义。
        -   ​**​ 关键性 (Critical)：​**​ 每个选项在定义时会被指定是 `Critical` 还是 `Non-Critical`。如果接收端遇到不认识的 `Critical` 选项（且 `C` 位被置位），必须丢弃数据包。`Non-Critical` 选项可以忽略。
        -

## 3. 外层传输头 (Outer Transport Header)​

Geneve 本身 ​**​ 不规定外层传输协议 ​**​，但最常用的是 ​**​UDP/IP​**​。

-   ​**​UDP 头：​**​
    -   ​**​ 源端口 (Source Port)：​**​ 通常由封装器（如 vSwitch）动态选择（可能基于流哈希）。
        -   ​**​ 目的端口 (Destination Port)：​**​ IANA 分配的 ​**​ 标准端口号是 `6081`​**​。
-   ​**​IP 头：​**​
    -   ​**​ 源 IP 地址：​**​ 隧道起点（封装点，如 Hypervisor 的物理网卡 IP 或 TOR 交换机 IP）。
        -   ​**​ 目的 IP 地址：​**​ 隧道终点（解封装点，目标 Hypervisor 或 TOR 交换机 IP）。可以是单播、组播或任播地址。
        -   ​**​ 协议字段：​**​ 设置为 `17` (UDP)。

## 4. ​ 外层以太网头 (Outer Ethernet Header)​

包含底层物理网络的源 MAC 地址和目的 MAC 地址（通常是下一跳路由器或交换机的 MAC）。

# ​Geneve 的关键特性与优势 ​

1. ​**​ 强大的元数据承载能力 (TLV Options)：​**​
    - ​**​ 核心价值：​**​ 允许在封装头中携带丰富的上下文信息，例如：
        - 安全策略 ID（防火墙规则、微分段）
        - 服务链路径 ID（指示数据包需要经过哪些虚拟网络功能 VNF，如防火墙、负载均衡器）
        - 服务质量 (QoS) 标记（优先级、带宽保证）
        - 网络遥测数据（采集点信息、丢包标记）
        - 租户/应用标识符（比 VNI 更细粒度）
        - 路径或连接标识符
        - 任何未来需要的控制信息
    - ​**​ 解耦控制与数据平面：​**​ SDN 控制器可以通过 Geneve 选项将策略“推送”到数据路径，交换机/网卡根据这些元数据执行动作，无需查复杂的流表或访问控制器，提高了性能和可编程性。
    - ​**​ 简化服务链：​**​ 服务链的编排信息可以直接携带在包中，指导数据包按顺序穿越不同的 VNF。
2. ​**​ 标准化的 VNI：​**​ 提供 24 位 VNI，与 VXLAN 兼容，解决了 VLAN 数量限制问题。
3. ​**​ 协议无关性：​**​ 可以封装任何类型的原始数据包（L2 或 L3）。
4. ​**​ 设计简洁与面向未来：​**​ 清晰的头部结构，预留了版本号和标志位，为未来扩展奠定了基础。可变长选项机制使其天生具有适应未来需求的能力。
5. ​**​ 标准化与开放性：​**​ IETF 标准协议，获得业界广泛支持（包括 VMware, Microsoft, Red Hat, Cisco, Intel, Broadcom 等），避免了厂商锁定。

# Geneve 的应用场景 ​

1. ​**​ 现代数据中心网络虚拟化：​**​ 是 VMware NSX-T, Microsoft Azure Virtual Network, Open Virtual Network (OVN) 等 SDN 解决方案首选的或支持的 Overlay 封装协议，用于构建多租户虚拟网络（VPC/VNet）、支持虚拟机/容器迁移。
2. ​**​ 云原生/容器网络：​**​ Kubernetes CNI 插件（如 Antrea, Cilium 的部分模式）支持 Geneve，为容器提供灵活、可扩展的网络连接和策略实施。
3. ​**​ 网络服务链：​**​ 通过携带服务链元数据，实现动态、可编程的服务链编排。
4. ​**​ 高级网络策略与安全：​**​ 携带安全上下文（如身份、组信息），实现基于身份的微分段和分布式防火墙。
5. ​**​ 网络遥测与可视化：​**​ 携带诊断和遥测信息，帮助监控和故障排除 Overlay 网络。

# Geneve 与 VXLAN 的主要区别 ​

| 特性               | VXLAN                        | Geneve                                      |
| ------------------ | ---------------------------- | ------------------------------------------- |
| ​**​ 核心目标 ​**​ | 解决 VLAN 限制，提供二层扩展 | 统一封装，提供可扩展元数据通道              |
| ​**​ 头部结构 ​**​ | 固定头部 (8 字节)            | 固定头部 + ​**​ 可变长 TLV 选项 ​**​        |
| ​**​ 元数据 ​**​   | ​**​ 仅 VNI (24 位)​**​      | ​**​VNI (24 位) + 任意 TLV 选项 ​**​        |
| ​**​ 灵活性 ​**​   | 较低，功能固定               | ​**​ 极高 ​**​，通过 TLV 无限扩展           |
| ​**​ 协议无关 ​**​ | 主要封装以太网帧 (TEB)       | 封装任意协议 (EtherType 指定)               |
| ​**​ 控制平面 ​**​ | 依赖组播或 EVPN 等           | ​**​ 原生支持 SDN 策略下发 ​**​ (通过选项)  |
| ​**​ 标准端口 ​**​ | UDP 4789                     | UDP 6081                                    |
| ​**​ 关键优势 ​**​ | 成熟、广泛部署、硬件卸载成熟 | ​**​ 未来证明、高度可编程、面向 SDN/NFV​**​ |

# 部署考虑 ​

-   ​**​ 硬件卸载：​**​ 现代智能网卡（SmartNIC）和数据中心交换机 ASIC 正在加速支持 Geneve 封装/解封装和选项处理（尤其是常见选项），以保持高性能。
-   ​**​MTU 问题：​**​ 封装会增加报文长度（通常至少 50 字节）。底层网络（Underlay）的 MTU 需要足够大（通常建议 >= 1600 字节，最好 9000 字节 Jumbo Frames）以避免分片，否则会严重影响性能。
-   ​**​ 控制平面：​**​ Geneve 本身只定义封装格式。需要一个强大的 SDN 控制平面（如 NSX Manager, OVN Northbound DB）来管理隧道端点、学习地址、分发策略并通过 Geneve 选项下发。
-   ​**​ 逐步演进：​**​ Geneve 可以部署在支持它的新节点上，并通过网关与传统 VXLAN 网络互通。

# 总结 ​

Geneve 代表了 Overlay 网络技术的下一代发展方向。它超越了简单的网络扩展（VXLAN 的主要目标），通过其创新的 ​**​ 可变长 TLV 选项机制 ​**​，为网络提供了前所未有的 ​**​ 可编程性、灵活性和上下文感知能力 ​**​。这使得 Geneve 成为构建面向 SDN/NFV、云原生、高度自动化且支持丰富网络服务的现代数据中心和云基础设施的理想选择。随着硬件加速的成熟和生态系统的完善，Geneve 正逐渐成为 Overlay 网络封装协议的新标准。
